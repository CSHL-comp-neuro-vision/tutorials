function [spd,qual] = metermeasspd(S)% [spd,qual] = metermeasspd(S)%% Make a measurement of the spectrum.%% 4/4/00  dhb, jdt  Add comments, clean.% 4/14/00 dhb       "quality"->"qual" so value is returned.global infoCif (isempty(infoC))   error('Meter has not been initialized.');endif (nargin < 1 | isempty(S))   S = [380 5 81];end% InitializereadStr=[];timeout = 30;% Flushing buffers.% fprintf('Flush\n');SERIAL('Read',infoC);% Make measurement% fprintf('Measure\n');SERIAL('Write',infoC,['m0' char(10)])waited = 0;while ((isempty(readStr))& (waited<timeout))   WaitSecs(1);   waited = waited+1;   readStr = SERIAL('Read',infoC);endif (waited == timeout)     error('No response after measure command');end% Get the data% fprintf('Get data\n');SERIAL('Write',infoC,['d5' char(10)]);readStr = SERIAL('Read',infoC);waited = 0;while ((isempty(readStr))& (waited<timeout))   WaitSecs(1);   waited = waited+1;   readStr = SERIAL('Read',infoC);endif (waited==timeout)   error('Unable to get reading from radiometer'); else   % fprintf('Got data\n');   qual = sscanf(readStr,'%f',1);   start=findstr(readStr,'0380.');   for (k=1:101)     spd(k)=str2num(readStr(start+6+17*(k-1):start+6+9+17*(k-1)));   end      % Convert to our units standard.   spd = 4*spd';      % Spline to desired wavelength sampling.   spd = SplineSpd([380 4 101],spd,S);end