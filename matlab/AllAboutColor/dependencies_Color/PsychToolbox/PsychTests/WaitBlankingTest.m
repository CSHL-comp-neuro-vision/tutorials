function WaitBlankingTest% WaitBlankingTest tests the 'WaitBlanking' function of SCREEN.mex. It does this by% using 'PeekBlanking' to measure the advance of time and frames caused by% a call to 'WaitBlanking' 10 frames. It does this twice for each screen. First% using whatever is the default setting of WaitBlankingAlwaysCallsSetClut (which is% set up by SCREEN when it first uses that screen, based on testing of% that screen) and then the opposite setting of WaitBlankingAlwaysCallsSetClut.% 1/15/98 dgp Wrote it.% 1/19/98 dgp Tried to make the print out more understandable.% 2/12/98 dgp Don't disable WaitForVBLInterrupt when ~SetClutDriverWaitsForVBL.% 3/14/98 dgp Test at all priorities.% 3/17/98 dgp Updated.% 7/25/98 dgp Updated for new Pref name.fprintf('Now testing WaitBlanking on each screen.\n');fprintf('SCREEN tries to set the WaitBlankingAlwaysCallsSetClut default (1=on,0=off) optimally for\n');fprintf('each screen. Here we test with the default setting and its opposite.\n');clear SCREENfor whichScreen=SCREEN('Screens')	fprintf('Screen %d\n',whichScreen);	f0=0;s0=0;f=0;s=0;GetSecs;SCREEN(whichScreen,'PeekBlanking');	t0=GetSecs;	[f0,s0]=SCREEN(whichScreen,'PeekBlanking');	[f,s]=SCREEN(whichScreen,'PeekBlanking');	t0=GetSecs-t0;	fprintf('%g MaxPriorityForBlankingInterrupt. \n',SCREEN(whichScreen,'Preference','MaxPriorityForBlankingInterrupt'));	for ww=0:1		waitBlankingAlwaysCallsSetClut=SCREEN(whichScreen,'Preference','WaitBlankingAlwaysCallsSetClut');		if waitBlankingAlwaysCallsSetClut			fprintf(' WaitBlankingAlwaysCallsSetClut: ');		else			fprintf('~WaitBlankingAlwaysCallsSetClut: ');		end		SCREEN(whichScreen,'WaitBlanking');		t=GetSecs;		[f0,s0]=SCREEN(whichScreen,'PeekBlanking');		SCREEN(whichScreen,'WaitBlanking',10);		[f,s]=SCREEN(whichScreen,'PeekBlanking');		t=GetSecs-t;		t=t-t0;		f=f-f0;		s=s-s0;		oldWarning=warning;		warning off		r=f/s;		warning(oldWarning);		fprintf('%3.0f Hz = %d frame/%5.3f s. WaitBlanking 10 took %5.3f s. ',r,f,s,t);		driverWaits=SCREEN(whichScreen,'Preference','SetClutDriverWaitsForBlanking');		if ~driverWaits			fprintf('\n');			break		end		fprintf('Priority: ');		SCREEN('Screens'); % Make sure all Rushed functions are in memory.		for p=[0 0.5 1:MaxPriority(whichScreen,'WaitBlanking')]			fprintf('%g ',p);			Rush('SCREEN(whichScreen,''WaitBlanking'');',p);		end		fprintf('\n');		SCREEN(whichScreen,'Preference','WaitBlankingAlwaysCallsSetClut',~waitBlankingAlwaysCallsSetClut);	end	clut=ClutDefault(whichScreen);	s=SetClutSecs(whichScreen,clut);	fprintf('A loop that just calls SetClut runs at %.0f Hz\n',1/s);	s=SetClutSecs(whichScreen,clut(1,:));	fprintf('A loop that just calls SetClut (just one entry) runs at %.0f Hz\n',1/s);	s=SetClutSecs(whichScreen,clut(1,:),0.001);	fprintf('A loop that just calls SetClut (just one entry) and 1 ms delay runs at %.0f Hz\n',1/s);endfunction s=SetClutSecs(w,clut,delaySecs,reps)% Times the period of a loop that calls SetClut plus a delay.% If SetClut waits for end-of-frame blanking then the period should always be a multiple of the frame period.% If SetClut doesn't wait then the period will be a fixed time plus delaySecs.if nargin<2 | isempty(clut)	clut=SCREEN(w,'GetClut');	if isempty(clut)		clut=ClutDefault(w);	endendif nargin<3 | isempty(delaySecs)	delaySecs=0;endif nargin<4 | isempty(reps)	reps=3;endreps=reps+1;p=MaxPriority(w,'WaitSecs','GetSecs');oldSetting=SCREEN(w,'Preference','SetClutCallsWaitBlanking',0);t=1:reps;loop={	'for i=1:reps;'		'WaitSecs(delaySecs);'		'SCREEN(w,''SetClut'',clut);'		't(i)=GetSecs;'	'end;'};WaitSecs(0);SCREEN('Screens');GetSecs; % Make sure all Rushed functions are in memory.Rush(loop,p);SCREEN(w,'Preference','SetClutCallsWaitBlanking',oldSetting);s=median(diff(t));return