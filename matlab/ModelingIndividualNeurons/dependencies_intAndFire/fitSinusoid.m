% function to fit spike times array with a sinusoid of% fixed phase. returns the amplitude and offset of the% sinusoid.function [amplitude, offset] = fitSinusoid(times, sptimesarr, freq)% if we call with only one frequency then fit% all the sinusoids to a single frequency.if (size(freq,2) == 1)  freq(1:size(sptimesarr,1)) = freq;endamplitude = [];offset = [];for i = 1:size(sptimesarr,1)  spiketimes = times(find(sptimesarr(i,:)));  intervals = spiketimes([2:end])-spiketimes([1:end-1]);  y = sin(2*pi*freq(i)*times/1000);  y = y(logical(sptimesarr(i,:)));  y = y(2:end);  X = [y',ones(size(intervals,2),1)];  b=regress(1000./intervals',X);  % Uncomment to display fits  %figure  %plot(spiketimes(2:end),1000./intervals); hold on; plot(spiketimes(2:end),b(1)*y+b(2),'mo');  amplitude = [amplitude b(1)];  offset = [offset b(2)];end