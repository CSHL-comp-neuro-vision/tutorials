% function GenerateRodCurrent%% Simulate rod current response to photons% arriving at specified times.  Rod response% is assumed to consist of stereotyped impulse % responses occurring at the photon arrival times with% independent and additive continuous and channel noise%% FMR 4/13/00%%function RodCurrent = GenerateRodCurrent(PhotonTimes, TimeConstant, ImpulseResponseAmp, ThermalProb, ContinuousNoiseAmp, ChannelNoiseAmp)numpts = length(PhotonTimes);Time = 1:numpts;% add thermals to photon streamThermals = POISSRND(ThermalProb, 1, numpts);PhotonTimes = PhotonTimes + Thermals;% generate impulse responses for photon-evoked events and continuous noise% eventsContinuousNoiseFilter = (Time/TimeConstant) .* exp(-Time/TimeConstant);ImpulseResponse = ImpulseResponseAmp .* (Time/TimeConstant).^3 .* exp(-Time/TimeConstant);ContinuousNoiseFilter = fft(ContinuousNoiseFilter);ImpulseResponse = fft(ImpulseResponse);% convolve impulse responses with stream of photon events and stream% of continuous noise events.  Add channel noise.  Do this for each rod in array.PhotonTimes = fft(PhotonTimes);PhotonTimes = ImpulseResponse .* PhotonTimes;PhotonTimes = real(ifft(PhotonTimes));ChannelNoise = NORMRND(0, ChannelNoiseAmp, 1, numpts);ContinuousNoise = NORMRND(0, ContinuousNoiseAmp, 1, numpts);ContinuousNoise = fft(ContinuousNoise);ContinuousNoise = ContinuousNoise .* ContinuousNoiseFilter;ContinuousNoise = real(ifft(ContinuousNoise));	RodCurrent = PhotonTimes + ContinuousNoise + ChannelNoise;